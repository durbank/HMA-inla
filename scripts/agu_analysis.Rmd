---
title: "AGU 2021 Notebook"
output: html_notebook
---

```{r}
library(here)
library(tidyverse)
library(ggpubr)
library(cetcolor)
library(sf)
library(INLA)
library(INLAutils)
library(spdep)
```

```{r}
# Import climate/glacier data
dat_sf <- read_sf(here("data/clim_data/glacier_clim.shp"))
dat_correct = read_sf(here("data/glacier-corrected.geojson")) %>% 
  st_drop_geometry() %>% 
  select(RGIId, temp_WARM, T_amp, P_tot, fracP_WARM, Group) %>% 
  rename(T_w = temp_WARM, P_w = fracP_WARM)

dat_sf = dat_sf %>% 
  select(RGIId, mb_mwea, area_km2, 
         z_med, z_aspct, z_slope, hi, 
         east, north, tau, t2_w_18, t2_w_b, 
         ppt_a_18, ppt_a_d, ppt_s_18, ppt_s_d) %>% 
  left_join(dat_correct)



dat <- dat_sf %>% st_drop_geometry() %>% select(-RGIId)
```

```{r}
# Log transforms
dat_norm <- dat %>%
  mutate(area_km2 = log(area_km2),
         z_slope = log(z_slope),
         tau = log(tau),
         ppt_s_18 = log(ppt_s_18), 
         T_w = log(T_w), 
         T_amp = log(T_amp), 
         P_tot = log(P_tot)
  )

# Scaling
dat_norm <- dat_norm %>%
  mutate(area_km2 = scale(area_km2),
         z_med = scale(z_med),
         z_aspct = scale(z_aspct),
         z_slope = scale(z_slope),
         hi = scale(hi),
         tau = scale(tau),
         t2_w_18 = scale(t2_w_18),
         t2_w_b = scale(t2_w_b, center = FALSE),
         ppt_a_18 = scale(ppt_a_18),
         ppt_a_d = scale(ppt_a_d, center = FALSE),
         ppt_s_18 = scale(ppt_s_18),
         ppt_s_d = scale(ppt_s_d, center = FALSE), 
         T_w = scale(T_w), 
         T_amp = scale(T_amp), 
         P_tot = scale(P_tot), 
         P_w = scale(P_w, center = FALSE)
         
  )
```

```{r}
set.seed(777)

dat_norm = dat_norm %>% mutate(idarea = 1:nrow(dat_norm))

alpha.list = sort(unique(dat_norm$Group))
idx.list = vector(mode = "list", length = length(alpha.list))
valid.idx = c()

# For each group, hold out 1,000 as a validation set and an additional 5,000 total as test set
for (i in 1:length(alpha.list)) {
  idx.i = which(dat_norm$Group == alpha.list[i])
  idx.list[[i]] = idx.i
  valid.idx = c(valid.idx, sample(idx.i, 1000))
}
test.idx = dat_norm$idarea[!(dat_norm$idarea %in% valid.idx)] %>% 
  sample(5000)

# Add train, test, and valid factors to tibble
dat_norm['Split'] = rep("Train", nrow(dat_norm))
dat_norm[valid.idx,'Split'] = "Valid"
dat_norm[test.idx,'Split'] = "Test"
dat_norm = dat_norm %>% mutate(Split = as.factor(Split))

```

```{r}
# INLA spatial graph
# # crds <- st_coordinates(dat_sf)
# coo <- cbind(dat$east / 1000,
#              dat$north / 1000)
# 
# nb <- graph2nb(gabrielneigh(coo), sym = TRUE)
# 
# nb2INLA(here("data/map.adj", nb))
g <- inla.read.graph(here("data/map.adj"))
                     
# Model priors
prior_bym <- list(prec.unstruct=list(prior='pc.prec',param=c(1, 0.025)),
                  prec.spatial=list(prior='pc.prec', param=c(1, 0.025)))

prior_bym2 <- list(
  prec = list(
    prior = "pc.prec",
    param = c(0.01 / 0.31, 0.01)),
  phi = list(
    prior = "pc",
    param = c(0.5, 2 / 3))
)
```

```{r}
idx.train = dat_norm$Split == 'Train'
dat.train = dat_norm
dat.train[!idx.train,'mb_mwea'] = NA

f.1 <- mb_mwea ~
  t2_w_b * T_w +
  t2_w_b * P_tot + ppt_a_d +
  P_w + ppt_s_d +
  hi +
  tau * z_med + z_slope + z_aspct + area_km2 +
  f(idarea, model = "bym2", graph = g, hyper = prior_bym2)

system.time(
  mod.1 <- inla(f.1, data = dat.train,
               control.predictor = list(compute = TRUE),
               control.compute = list(dic = TRUE, waic = TRUE))
)
```